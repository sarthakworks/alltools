const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["astro/pdf-vendor.5vxXXNST.js","astro/vendor.Ml7xHclh.js"])))=>i.map(i=>d[i]);
import{r as e,o as s,q as t,j as a,D as n,t as r,S as l,v as i,w as o,_ as c,x as d,F as g,y as m,K as p,P as u}from"./vendor.Ml7xHclh.js";import{P as h}from"./pdf-vendor.5vxXXNST.js";import{F as x}from"./fileUploader.B1Dwo65Z.js";import{c as f}from"./utils.Ceoo1Swf.js";import{u as y,p as w,i as b}from"./pdf.BjHsYDCh.js";import{P as j}from"./ProcessButton.mPdpvfTx.js";import{D as v}from"./DraggablePage.BjWmOmmx.js";import{s as N,t as F,u as k,o as P,X as D,q as S,v as $}from"./lucide-icons.CJY1ueNI.js";function C(){const{files:C,addFiles:I,removeFile:E,replaceFile:B,filesRef:U,isProcessing:M,processingProgress:R,processingMessage:q,setProcessingState:T}=y({multiple:!0}),[_,A]=e.useState([]),[G,V]=e.useState("list"),[L,z]=e.useState(null),[K,O]=e.useState({}),[H,J]=e.useState(null),[Q,W]=e.useState(""),[X,Y]=e.useState(!0),[Z,ee]=e.useState(0),[se,te]=e.useState(!1),[ae,ne]=e.useState(null),[re,le]=e.useState([]),ie=s(t(u),t(p,{coordinateGetter:m})),oe=async e=>{T(!0,"Processing files...",0);const s=[],t=e.length;for(let i=0;i<e.length;i++){const a=e[i];T(!0,`Checking file ${i+1}/${t}: ${a.name}`,Math.round(i/t*50));try{const l=await a.arrayBuffer();try{await h.load(l),s.push(a)}catch(n){if(!n.message?.includes("encrypted")&&"EncryptedPDFError"!==n.name)throw n;T(!0,`Unlocking ${a.name}...`);try{await h.load(l,{password:""}),s.push(a)}catch{try{const e=await w(l,"",e=>{const s=i/t*50,n=e/100*(50/t);T(!0,`Unlocking ${a.name}...`,Math.round(s+n))}),n=new Blob([e],{type:"application/pdf"}),r=new File([n],a.name,{type:"application/pdf"});s.push(r)}catch(r){const t=U.current.length+s.length;ne(a);const n=e.slice(i+1);le(n),J({fileIndex:t,fileName:a.name}),T(!1);const l=U.current.length;return I([...s,a]),void(s.length>0&&ce(s,l))}}}}catch(l){s.push(a)}}const a=U.current.length;I(s),await ce(s,a)},ce=async(e,s,t)=>{T(!0,"Generating thumbnails...");const a=await c(()=>import("./pdf-vendor.5vxXXNST.js").then(e=>e.p),__vite__mapDeps([0,1]));await b();const n=[];for(let i=0;i<e.length;i++){const t=e[i];T(!0,`Generating thumbnails ${i+1}/${e.length}`,50+Math.round((i+1)/e.length*50));try{const e=await t.arrayBuffer();let l;try{const s=a.getDocument({data:e});l=await s.promise}catch(r){if("PasswordException"!==r.name)throw r;{const s=a.getDocument({data:e,password:""});l=await s.promise}}for(let a=1;a<=l.numPages;a++){const e=await l.getPage(a),r=e.getViewport({scale:.5}),o=document.createElement("canvas"),c=o.getContext("2d");o.height=r.height,o.width=r.width,c&&(await e.render({canvasContext:c,viewport:r}).promise,n.push({id:`f${s+i}-p${a}-${Date.now()}-${Math.random()}`,fileIndex:s+i,pageIndex:a-1,image:o.toDataURL(),fileName:t.name}))}}catch(l){}}A(e=>[...e,...n]),e.length>0&&V("grid"),T(!1)},de=e=>{A(s=>s.filter(s=>s.id!==e))},ge=async()=>{if(!H)return;const{fileIndex:e,fileName:s}=H,t=Q,a=ae||C[e];if(a)if(W(""),X)try{const n=await a.arrayBuffer();te(!0);const r=await w(n,t,e=>{ee(e)});te(!1);const l=new Blob([r],{type:"application/pdf"}),i=new File([l],s,{type:"application/pdf"});if(B(e,i),await ce([i],e),O(s=>({...s,[e]:""})),Y(!0),J(null),ne(null),re.length>0){const e=re;le([]),setTimeout(()=>oe(e),100)}}catch(n){alert(`Force unlock failed: ${n?.message||"Unknown error"}`),ne(null),te(!1),J(null)}else{te(!0);try{const n=await a.arrayBuffer(),r=await w(n,t,e=>{ee(e)}),l=new Blob([r],{type:"application/pdf"}),i=new File([l],s,{type:"application/pdf"});if(B(e,i),O(s=>({...s,[e]:""})),await ce([i],e),ne(null),J(null),re.length>0){const e=re;le([]),setTimeout(()=>oe(e),100)}}catch(n){n.message?.includes("encrypted")||n.message?.includes("ignoreEncryption")?(alert('This PDF uses encryption that requires Force Unlock.\n\nPlease:\n1. Check the "Force Unlock (Flatten PDF)" option\n2. Re-enter your password (or leave empty)\n3. Click Submit again'),W(""),Y(!0)):(alert(`Password incorrect or unlock failed: ${n?.message||"Unknown error"}`),J(null)),ne(null)}finally{te(!1)}}else alert("File not found")};return a.jsxs("div",{className:"space-y-8",children:[C.length>0&&a.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4 p-4 bg-gray-50 rounded-xl border border-gray-200",children:[a.jsxs("div",{className:"flex gap-2",children:[a.jsx("button",{onClick:()=>V("list"),className:f("p-2 rounded-lg transition-colors","list"===G?"bg-white shadow text-blue-600":"text-gray-500 hover:bg-gray-200"),title:"File List View",children:a.jsx(N,{className:"w-5 h-5"})}),a.jsx("button",{onClick:()=>V("grid"),className:f("p-2 rounded-lg transition-colors","grid"===G?"bg-white shadow text-blue-600":"text-gray-500 hover:bg-gray-200"),title:"Page Grid View",children:a.jsx(F,{className:"w-5 h-5"})})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs("button",{onClick:()=>{A(e=>{const s=[...e];for(let t=s.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[s[t],s[e]]=[s[e],s[t]]}return s})},className:"flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors",children:[a.jsx(k,{className:"w-4 h-4"})," Shuffle"]}),a.jsxs("span",{className:"text-sm text-gray-500 self-center",children:[_.length," pages"]})]})]}),a.jsx("div",{className:"min-h-75",children:0===C.length?a.jsx(x,{onFilesSelected:oe,accept:{"application/pdf":[".pdf"]},multiple:!0}):a.jsxs(a.Fragment,{children:["list"===G&&a.jsxs("div",{className:"space-y-3",children:[C.map((e,s)=>a.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl bg-gray-50 border border-gray-200",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(P,{className:"w-5 h-5 text-red-500"}),a.jsx("span",{className:"text-sm font-medium text-gray-700",children:e.name}),a.jsxs("span",{className:"text-xs text-gray-400",children:["(",(e.size/1024/1024).toFixed(2)," MB)"]})]}),a.jsx("button",{onClick:()=>{return E(e=s),void A(s=>s.filter(s=>s.fileIndex!==e).map(s=>({...s,fileIndex:s.fileIndex>e?s.fileIndex-1:s.fileIndex})));var e},className:"p-1.5 hover:bg-gray-200 rounded-full text-gray-400 hover:text-gray-600 transition-colors",children:a.jsx(D,{className:"w-4 h-4"})})]},`${e.name}-${s}`)),a.jsx("div",{className:"mt-6",children:a.jsx(x,{onFilesSelected:oe,accept:{"application/pdf":[".pdf"]},multiple:!0,className:"py-8"})})]}),"grid"===G&&a.jsxs(n,{sensors:ie,collisionDetection:r,onDragEnd:e=>{const{active:s,over:t}=e;s.id!==t.id&&A(e=>{const a=e.findIndex(e=>e.id===s.id),n=e.findIndex(e=>e.id===t.id);return d(e,a,n)}),z(null)},onDragStart:e=>z(e.active.id),children:[a.jsx(l,{items:_.map(e=>e.id),strategy:i,children:a.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4",children:[_.map(e=>a.jsx(v,{...e,onRemove:de},e.id)),a.jsxs("div",{className:"aspect-3/4 flex items-center justify-center bg-gray-50 border-2 border-dashed border-gray-200 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer",onClick:()=>document.getElementById("add-more-pdf")?.click(),children:[a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-2",children:a.jsx("span",{className:"text-xl",children:"+"})}),a.jsx("span",{className:"text-xs text-gray-500 font-medium",children:"Add More"})]}),a.jsx("input",{id:"add-more-pdf",type:"file",multiple:!0,accept:".pdf",className:"hidden",onChange:e=>{e.target.files&&oe(Array.from(e.target.files))}})]})]})}),a.jsx(o,{children:L?a.jsx("div",{className:"aspect-3/4 bg-white rounded-lg shadow-xl overflow-hidden opacity-90 cursor-grabbing border-2 border-blue-500",children:a.jsx("img",{src:_.find(e=>e.id===L)?.image,className:"w-full h-full object-contain p-2"})}):null})]})]})}),H&&a.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:a.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 space-y-4",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center",children:a.jsx(S,{className:"w-6 h-6"})}),a.jsxs("div",{children:[a.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"Password Required"}),a.jsxs("p",{className:"text-sm text-gray-500",children:["File: ",H.fileName]})]})]}),a.jsx("p",{className:"text-sm text-gray-600",children:"This PDF is password protected. Please enter the password to continue merging."}),a.jsx("input",{type:"password",value:Q,onChange:e=>W(e.target.value),onKeyDown:e=>"Enter"===e.key&&!se&&ge(),placeholder:"Enter password (or leave empty)",className:"w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all",autoFocus:!0,disabled:se}),a.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg flex items-start gap-3",children:[a.jsx("input",{type:"checkbox",id:"force-unlock-merge",checked:X,onChange:e=>Y(e.target.checked),className:"mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500",disabled:se}),a.jsxs("label",{htmlFor:"force-unlock-merge",className:"text-sm text-gray-700 cursor-pointer",children:[a.jsx("span",{className:"font-semibold block text-gray-900",children:"Force Unlock (Flatten PDF)"}),a.jsx("span",{className:"text-gray-500",children:"Enable if password doesn't work. Converts pages to images (high quality)."})]})]}),se&&a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-600",children:[a.jsx("span",{children:"Unlocking PDF..."}),a.jsxs("span",{className:"font-medium",children:[Z,"%"]})]}),a.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2 overflow-hidden",children:a.jsx("div",{className:"bg-blue-600 h-full transition-all duration-300",style:{width:`${Z}%`}})})]}),a.jsx("div",{className:"flex gap-2",children:a.jsx("button",{onClick:ge,disabled:se,className:"w-full px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:se?"Processing...":"Submit"})}),a.jsx("p",{className:"text-xs text-gray-500 text-center",children:X?"Force Unlock will flatten the PDF by rendering pages as high-quality images.":'Tip: Check "Force Unlock" if you don\'t know the password or standard unlock fails.'})]})}),a.jsxs(j,{onClick:async()=>{if(0!==_.length){T(!0,"Merging PDFs...");try{const s=await h.create(),t=[...new Set(_.map(e=>e.fileIndex))],a={};for(const l of t){const s=U.current;if(s[l])try{const e=await s[l].arrayBuffer();a[l]=await h.load(e)}catch(e){const t=s[l]?.name||"Unknown File";return e.message?.includes("encrypted")?(alert(`ERROR: File "${t}" is still encrypted.`),void T(!1)):(alert(`Failed to load ${t}: ${e.message}`),void T(!1))}}for(const e of _){if(!a[e.fileIndex])continue;const t=a[e.fileIndex],[n]=await s.copyPages(t,[e.pageIndex]);s.addPage(n)}const n=await s.save(),r=new Blob([n],{type:"application/pdf"});g.saveAs(r,`merged-document-${Date.now()}.pdf`)}catch(s){alert("Failed to merge PDFs. Please try again.")}finally{T(!1)}}},disabled:M||_.length<1,isProcessing:M,processingMessage:q,progress:R,icon:$,children:["Merge ",_.length," Pages"]})]})}export{C as default};
